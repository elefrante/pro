<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRS - Sesion Iniciada</title>
    <link rel="stylesheet" href="../usuario/css/estilos.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gabarito:wght@400..900&family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&family=Lato:ital,wght@0,100;0,300;0,400;0,700;0,900;1,100;1,300;1,400;1,700;1,900&family=Raleway:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
  <!-- HEADER -->
  <header>
    <div class="header-content">
        <a class="logo" href="../LandingYLogin/landing.html">
            <img style="height: 60px; width: 60px;" src="../imgs/Logo1.png" alt="Logo de la cooperativa" />
            <h1 style="padding-left: 5px;">CRS</h1>
        </a>
        <h2 id="saludo">Cargando...</h2>

        <!-- Menú de navegación -->
        <nav>
            <ul>
                <li><a href="inicio.html" class="active">Inicio</a></li>
                <li><a href="comprobantes.html" >Comprobantes</a></li>
                <li><a href="horasTrabajo.html" >Registro de Horas</a></li>
            </ul>
        </nav>

        <div class="noti-container">
                <img id="campana" src="../imgs/campanita.webp" class="campana-icon">
                <!-- Puntito rojo (notificaciones nuevas) -->
                <span id="notiIndicator" class="noti-indicator"></span>
            </div>
            <!-- Panel desplegable -->
            <div id="panelNotificaciones" class="panel-noti"></div>

            <a href="#" class="logout" onclick="cerrarSesion()">Cerrar Sesión</a>

    </div>
</header>

  <!-- CONTENIDO PRINCIPAL -->
  <main class="main-content">
    <!-- Panel izquierdo -->
    <section class="left-panel">
      <div class="user-card">
        <div id="userImg"></div>
        <div class="user-info">
          <h2 id="Nombre">Cargando...</h2>
          <p id="ci" class="user-id">Cargando...</p>
          <button class="edit-btn" onclick="editarFoto()">Editar Foto</button>
          <input type="file" id="inputFoto" style="display:none" accept="image/*">
        </div>
      </div>
      <section class="data-user">
        <div class="info-card">
          <p id="FNac"><strong>Fecha de Nacimiento:</strong>Cargando...</p>
        </div>
        <div class="info-card">
          <p id="uniHab"><strong>Unidad Habitacional:</strong>Cargando...</p>
        </div>
        <div class="info-card">
          <p id="email"><strong>Email:</strong>Cargando...<img class="edit-icon" src="../imgs/editar.png" alt="editar"></p>
        </div>
        <div class="info-card">
          <p id="tel"><strong>Teléfono:</strong>Cargando...<img class="edit-icon" src="../imgs/editar.png" alt="editar"></p>
        </div>
      </section>
    </section>

    <!-- Panel derecho -->
    <section class="right-panel">
      <h2>Reportes</h2>
      <div id="reportes"></div>
    </section>
  </main>
  <footer class="footer">
    <p>© 2025 Cooperativa Richie Silver (CRS)</p>
    <a href="https://wa.me/59898843651"><img style="height: 40px; width: 40px;" src="../imgs/whatsapp.png"></a>
  </footer>
</body>
</html>

<script>
const usuarioCedula = localStorage.getItem('usuarioCedula');
if (!usuarioCedula) {
    window.location.href = "../LandingYLogin/landing.html";
}


// --- FUNCION PARA FORMATEAR FECHA ---
function formatearFecha(fechaISO) {
    const meses = [
        "enero", "febrero", "marzo", "abril", "mayo", "junio",
        "julio", "agosto", "septiembre", "octubre", "noviembre", "diciembre"
    ];

    const partes = fechaISO.split("-"); // evita el problema de la zona horaria
    const año = partes[0];
    const mes = meses[parseInt(partes[1]) - 1];
    const dia = parseInt(partes[2]);

    return `${dia} de ${mes}, ${año}`;
}


if (!usuarioCedula) {
    document.getElementById('saludo').innerText = "No has iniciado sesión.";
    document.getElementById('Nombre').innerText = "No has iniciado sesión.";
} else {
    fetch(`../APIUsuarios/api.php/usuarios/${usuarioCedula}`)
        .then(res => res.json())
        .then(usuario => {
            const nombreCompleto = `${usuario.nombre} ${usuario.apellido}`;
            document.getElementById('saludo').innerHTML = `Bienvenido, <strong>${nombreCompleto}</strong>`;
            document.getElementById('Nombre').innerHTML = nombreCompleto;
            document.getElementById('ci').innerHTML = usuarioCedula;
            document.getElementById('FNac').innerHTML = `<strong>Fecha de Nacimiento:</strong> ${usuario.fecha_nacimiento}`;
            const unidadHab = usuario.unidad_habitacional || "Sin Asignar";
            document.getElementById('uniHab').innerHTML = `<strong>Unidad Habitacional:</strong> ${unidadHab}`;
            document.getElementById('email').innerHTML = `<strong>Email:</strong> <span id="emailText">${usuario.email}</span> <img class="edit-icon" src="../imgs/editar.png" onclick="editarCampo('email')">`;
            document.getElementById('tel').innerHTML = `<strong>Teléfono:</strong> <span id="telText">${usuario.telefono}</span> <img class="edit-icon" src="../imgs/editar.png" onclick="editarCampo('tel')">`;
            document.getElementById('userImg').innerHTML = `<img class="user-img" src="../APIUsuarios/${usuario.perfil}" alt="Foto de Perfil">`;
        });
}

// Foto de perfil
function editarFoto() {
    document.getElementById('inputFoto').click();
}

document.getElementById('inputFoto').addEventListener('change', function (event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
        const base64Image = e.target.result;
        fetch(`../APIUsuarios/api.php/usuarios/${usuarioCedula}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ perfil: base64Image })
        })
        .then(res => res.json())
        .then(resp => {
            if (resp.success) {
                document.getElementById('userImg').innerHTML = `<img class="user-img" src="../APIUsuarios/${resp.perfil}?t=${new Date().getTime()}" alt="Foto de Perfil">`;
                alert("Foto actualizada correctamente");
            } else alert("Error al actualizar la foto");
        });
    };
    reader.readAsDataURL(file);
});

// Editar email o teléfono
function editarCampo(campoHtml) {
    const campoBD = campoHtml === "tel" ? "telefono" : campoHtml;

    const span = document.getElementById(campoHtml + "Text");
    const valorActual = span.innerText;
    const input = document.createElement("input");
    input.type = "text";
    input.value = valorActual;
    input.id = campoHtml + "Input";
    span.replaceWith(input);
    input.focus();

    input.addEventListener("keypress", function(e) {
        if (e.key === "Enter") actualizarCampo(campoBD, input.value, campoHtml);
    });
    input.addEventListener("blur", function() {
        actualizarCampo(campoBD, input.value, campoHtml);
    });
}

function actualizarCampo(campoBD, nuevoValor, campoHtml) {
    const input = document.getElementById(campoHtml + "Input");
    fetch(`../APIUsuarios/api.php/usuarios/${usuarioCedula}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ [campoBD]: nuevoValor })
    })
    .then(res => res.json())
    .then(resp => {
        const span = document.createElement("span");
        span.id = campoHtml + "Text";
        span.innerText = nuevoValor;
        input.replaceWith(span);
    });
}

// --- REPORTES ---
fetch("../APICooperativa/apiReportes.php")
    .then(res => res.json())
    .then(reportes => {
        const cont = document.getElementById("reportes");
        cont.innerHTML = "";

        reportes.forEach(r => {
            cont.innerHTML += `
            <div class="news-card">
                <h3>${r.titulo}</h3>
                <p class="fecha-reporte"><strong> ${formatearFecha(r.fecha)}</strong></p>
                <p>${r.descripcion}</p>
                ${
                    r.nombre_arch 
                    ? `<a class="download-btn" href="../apiCooperativa/apiReportes.php?archivo=1&id=${r.id_reporte}" target="_blank">Ver archivo</a>` 
                    : `<p><em>Sin archivo adjunto</em></p>`
                }
            </div>`;
        });
    });
    function cerrarSesion() {
  localStorage.removeItem("usuarioCedula");
  window.location.href = "../LandingYLogin/landing.html"; 
}

async function cargarNotificaciones() {
    const panel = document.getElementById("panelNotificaciones");
    const icono = document.getElementById("campana");
    const indicator = document.getElementById("notiIndicator");

    const res = await fetch(`../APICooperativa/apiNotificaciones.php?cedula=${usuarioCedula}`);
    const datos = await res.json();

    panel.innerHTML = "";

    let hayNoVistas = false;

    if (datos.length === 0) {
        panel.innerHTML = '<p style="text-align: center; color: #999; padding: 20px;">No hay notificaciones</p>';
    } else {
        datos.forEach(n => {
            if (n.estado == 0) hayNoVistas = true;

            panel.innerHTML += `
                <div class="noti-card ${n.estado == 0 ? 'no-vista' : ''}">
                    <div class="noti-header">
                        <h4>${n.titulo}</h4>
                        ${n.estado == 0 ? '<span class="noti-badge">●</span>' : ''}
                    </div>
                    <p>${n.descripcion_breve}</p>
                </div>
            `;
        });
    }

    // Mostrar/ocultar indicador según si hay no vistas
    if (hayNoVistas) {
        indicator.style.display = "block";
    } else {
        indicator.style.display = "none";
    }
}

async function marcarComoVistas() {
    await fetch("../APICooperativa/marcarComoVistas.php?cedula=" + usuarioCedula);
    cargarNotificaciones();
}

// Evento de abrir panel
document.getElementById("campana").addEventListener("click", () => {
    document.getElementById("panelNotificaciones").classList.toggle("activo");
    if (document.getElementById("panelNotificaciones").classList.contains("activo")) {
        marcarComoVistas();
    }
});

cargarNotificaciones();
</script>